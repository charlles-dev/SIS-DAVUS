# **1\. Database Schema & Data Dictionary**

Projeto: Davus Engenharia  
Versão: 1.5.1  
Engine: PostgreSQL 16 (Supabase)

## **1\. Configurações do PostgreSQL (Supabase)**

### **1.1. Extensions Obrigatórias**

Estas extensões devem ser habilitadas no painel do Supabase (*Database \> Extensions*):

* uuid-ossp: Para geração de IDs (UUIDv4).  
* pg\_trgm: Para busca textual eficiente (TrigramSimilarity) em nomes de produtos, vital para performance sem ElasticSearch.

### **1.2. Schemas**

* public: Onde residem todas as tabelas do Django.

## **2\. Detalhamento das Tabelas**

### **2.1. App: core (Usuários e Autenticação)**

Tabela: core\_user  
Extende AbstractUser padrão do Django.

| Coluna | Tipo | Constraint | Descrição Detalhada |
| :---- | :---- | :---- | :---- |
| id | UUID | PK, Default uuid\_generate\_v4() | Identificador imutável. |
| username | VARCHAR(150) | UNIQUE, NOT NULL | CPF ou Email. Usado para login. |
| full\_name | VARCHAR(255) | NOT NULL | Nome de exibição nos relatórios. |
| role | VARCHAR(20) | NOT NULL | Enum: ADMIN, MANAGER, OPERATOR. Controla renderização condicional no Front. |
| is\_active | BOOLEAN | Default TRUE | Soft delete. Usuários nunca são apagados fisicamente para manter integridade de logs. |

### **2.2. App: inventory (Controle de Estoque)**

**Tabela:** inventory\_category

| Coluna | Tipo | Constraint | Descrição |
| :---- | :---- | :---- | :---- |
| id | UUID | PK |  |
| name | VARCHAR(100) | UNIQUE | Ex: "Hidráulica", "EPIs". |

**Tabela:** inventory\_product

| Coluna | Tipo | Constraint | Descrição |
| :---- | :---- | :---- | :---- |
| id | UUID | PK |  |
| category\_id | UUID | FK \-\> inventory\_category | ON DELETE SET NULL. |
| name | VARCHAR(255) | NOT NULL | Nome do material. Indexado via GinIndex (pg\_trgm) para busca fuzzy. |
| unit | VARCHAR(10) | NOT NULL | Enum: M3, SC, UN, KG. Validado no serializer. |
| current\_stock | DECIMAL(10,2) | Default 0.00 | Quantidade atual. Atualizada atomicamente via F() expressions. |
| min\_threshold | DECIMAL(10,2) | Default 5.00 | Ponto de pedido. Gatilho para alertas. |
| last\_updated | TIMESTAMP | Auto Now | Data da última movimentação. |

**Tabela:** inventory\_stockmovement (Ledger/Livro Razão)

| Coluna | Tipo | Constraint | Descrição |
| :---- | :---- | :---- | :---- |
| id | UUID | PK |  |
| product\_id | UUID | FK \-\> inventory\_product | ON DELETE PROTECT (Não apagar produto com histórico). |
| created\_by\_id | UUID | FK \-\> core\_user | Quem fez a movimentação. |
| type | VARCHAR(3) | NOT NULL | IN (Entrada), OUT (Saída). |
| quantity | DECIMAL(10,2) | Check \> 0 | Valor absoluto movimentado. |
| created\_at | TIMESTAMP | Default Now | Data da transação. |

### **2.3. App: assets (Patrimônio)**

**Tabela:** assets\_asset

| Coluna | Tipo | Constraint | Descrição |
| :---- | :---- | :---- | :---- |
| id | UUID | PK |  |
| asset\_tag | VARCHAR(50) | UNIQUE, Index | Código da etiqueta (Ex: DAV-001). |
| name | VARCHAR(255) | NOT NULL | Descrição (Ex: Furadeira Bosch 650w). |
| status | VARCHAR(20) | Default AVAILABLE | Enum: AVAILABLE, IN\_USE, MAINTENANCE, DISCARDED. |
| location\_id | UUID | FK \-\> assets\_location | Localização física (Obra/Sede). |
| qr\_code\_url | TEXT | NULL | URL pública do PDF da etiqueta no Supabase Storage. |

**Tabela:** assets\_image (Evidências)

| Coluna | Tipo | Constraint | Descrição |
| :---- | :---- | :---- | :---- |
| id | UUID | PK |  |
| asset\_id | UUID | FK \-\> assets\_asset | Vínculo com o equipamento. |
| image\_path | VARCHAR(500) | NOT NULL | Caminho relativo no Bucket (ex: evidence/2025/11/uuid.webp). O Frontend monta a URL completa. |
| type | VARCHAR(20) | NOT NULL | DAMAGE (Avaria), DELIVERY (Entrega). |

## **3\. SQL Views & Procedures (Para Analytics)**

Como não temos ferramentas de BI pagas, criaremos Views no banco para facilitar queries de Dashboard:

\-- View para Custo Total de Inventário  
CREATE VIEW view\_inventory\_value AS  
SELECT   
    SUM(p.current\_stock \* p.avg\_price) as total\_value,  
    COUNT(\*) as total\_items  
FROM inventory\_product p;  
