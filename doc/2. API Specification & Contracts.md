# **2\. API Specification & Contracts**

Versão: 1.5.1  
Base URL: https://davus-backend.onrender.com/api/v1

## **1\. Tratamento de Erros e Latência (Render Specifics)**

### **1.1. Timeout Handling**

Devido ao "Cold Start" do Render, requisições podem demorar. O cliente deve:

* Timeout configurado para **60 segundos** no Axios.  
* Retentativa (Retry) automática para status 502 (Bad Gateway) ou 504 (Gateway Timeout), comum durante o wake-up.

### **1.2. Padrão de Resposta de Erro**

{  
  "status": "error",  
  "code": "insufficient\_stock",  
  "message": "Estoque insuficiente para realizar a saída.",  
  "data": {  
    "requested": 10,  
    "available": 5  
  }  
}

## **2\. Endpoints Detalhados**

### **2.1. Health Check (Keep-Alive)**

* **GET** /health/  
* **Auth:** Pública.  
* **Response:** 200 OK {"status": "online", "db\_latency": "120ms"}  
* **Uso:** Chamado pelo UptimeRobot a cada 5 min para manter o container ativo.

### **2.2. Inventory**

#### **POST /inventory/movements/**

Registra entrada ou saída. Operação atômica.

* **Request Body:**  
  {  
    "product\_id": "550e8400-e29b-41d4-a716-446655440000",  
    "type": "OUT",  
    "quantity": 2.5,  
    "notes": "Consumo na Laje 3"  
  }

* **Response (201 Created):**  
  {  
    "id": "uuid...",  
    "new\_stock\_level": 12.5,  
    "alert": null  
  }

* **Lógica de Backend (Free Tier Optimization):**  
  1. Usa select\_for\_update() para travar a linha do produto (Lock Pessimista).  
  2. Verifica saldo.  
  3. Atualiza saldo.  
  4. Invalida cache da chave product\_list no Redis (Upstash).

### **2.3. Assets & Images**

#### **POST /assets/{id}/evidence/**

Upload de imagem de avaria.

* **Header:** Content-Type: multipart/form-data  
* **Form Data:** file (Binary), type ("DAMAGE")  
* **Processamento Interno:**  
  1. Django recebe arquivo em memória (Stream).  
  2. Valida extensão (.jpg, .png) e tamanho (\< 4MB).  
  3. Usa boto3 (configurado para endpoint S3 do Supabase) para upload.  
  4. Salva referência no Postgres.  
  5. Retorna URL pública.

### **2.4. Dashboard (Cached)**

#### **GET /dashboard/summary/**

Dados pesados de agregação.

* **Cache:** Servidor (Django) define header Cache-Control: public, max-age=300 (5 minutos).  
* **Implementação:** O Backend verifica se existe a chave dashboard\_stats no Redis. Se sim, retorna direto (50ms). Se não, roda query SQL pesada (2s), salva no Redis e retorna.

## **3\. Headers de Segurança (Vercel & Render)**

O backend deve injetar os seguintes headers CORS:

* Access-Control-Allow-Origin: https://davus.vercel.app (Restrito à produção).  
* Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS.