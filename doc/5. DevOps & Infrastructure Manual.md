# **5\. DevOps & Infrastructure Manual**

**Objetivo:** Guia passo-a-passo para deploy do zero até produção sem cartão de crédito.

## **1\. Provisionamento de Dados (Supabase)**

1. **Criar Projeto:** Acesse Supabase e crie "Davus-Prod". Salve a senha do DB.  
2. **Connection String:** Vá em *Settings \> Database*.  
   * Copie a URL de **Connection Pooler** (Mode: Transaction, Port: 6543).  
   * *Formato:* postgres://postgres.user:\[password\]@aws-0-sa-east-1.pooler.supabase.com:6543/postgres  
   * *Nota:* Não use a porta 5432 (Session) no Render Free, você terá erros de conexão.  
3. **Storage:**  
   * Menu *Storage* \> *New Bucket* \> Name: davus-media.  
   * Habilitar "Public Bucket".  
   * *Policies:* Adicionar Policy para SELECT (Public) e INSERT/UPDATE (Auth Users apenas \- mas como faremos via Backend, a Service Key resolve).

## **2\. Configuração Redis (Upstash)**

1. **Criar Database:** Acesse Upstash Console \> Create Database \> "Davus-Cache".  
2. **Região:** Selecione us-east-1 (mesma do Render para menor latência).  
3. **Endpoint:** Copie o link rediss://default:\*\*\*@...upstash.io:6379.  
   * *Atenção:* Use o prefixo rediss:// (com dois 's') para habilitar SSL, obrigatório.

## **3\. Backend Deploy (Render)**

1. **New Web Service:** Conecte o repositório GitHub.  
2. **Runtime:** Python 3\.  
3. **Build Command:**  
   pip install \-r requirements.txt && python manage.py collectstatic \--noinput && python manage.py migrate

4. **Start Command:**  
   gunicorn core.wsgi:application \--bind 0.0.0.0:$PORT \--workers 2 \--threads 2 \--timeout 120

   * *Nota:* Timeout aumentado para lidar com instabilidade.  
5. **Variáveis de Ambiente (Environment):**  
   * PYTHON\_VERSION: 3.11.0  
   * DATABASE\_URL: (Cole a URL do Supabase Pooler 6543\)  
   * REDIS\_URL: (Cole a URL do Upstash)  
   * SECRET\_KEY: (Gere uma hash aleatória)  
   * DEBUG: False  
   * ALLOWED\_HOSTS: \* (ou o domínio do Render)  
   * SUPABASE\_URL: https://\[seu-id\].supabase.co  
   * SUPABASE\_KEY: (Sua Service Role Key para uploads)

## **4\. Frontend Deploy (Vercel)**

1. **New Project:** Importe o repo do GitHub.  
2. **Build Settings:** Default do Vite (npm run build, output dist).  
3. **Env Variables:**  
   * VITE\_API\_URL: https://\[nome-do-seu-servico\].onrender.com/api/v1  
4. **Deploy:** Clique em Deploy.  
5. **Pós-Deploy:** Copie a URL gerada (ex: davus.vercel.app) e adicione no CORS\_ALLOWED\_ORIGINS nas variáveis do Render (Passo 3).

## **5\. Manutenção e Monitoramento**

### **5.1. Manter Vivo (Keep-Alive)**

Crie uma conta no **UptimeRobot** (Free):

* **Monitor Type:** HTTP(s).  
* **URL:** https://\[seu-backend\].onrender.com/health/.  
* **Intervalo:** 5 minutos.  
* *Efeito:* Isso impede que o Render entre em "Deep Sleep", reduzindo o cold start de 30s para 2-3s.

### **5.2. Backup de Segurança**

Como o Supabase Free tem backup de apenas 1 dia (Point-in-time), configure um script local ou GitHub Action mensal para rodar:  
pg\_dump \[connection\_string\] \> backup\_davus\_$(date).sql